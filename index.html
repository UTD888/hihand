<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>High Hand Bonus</title>
  <style>
    .history-img {
    height: 32px;
    margin-right: 6px;
    vertical-align: middle;
    border-radius: 4px;
  }
    body { background: #111; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
    .admin-bar { margin-bottom: 20px; }
    button { padding: 8px 14px; margin: 6px; font-size: 16px; }
    .hidden { display: none; }
    .bonus-section { max-width: 600px; margin: auto; text-align: left; background: #222; padding: 20px; border-radius: 10px; }
    .bonus-section h2 { text-align: center; }
    .bonus-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #444; }
    #history-container { margin-top: 20px; display: none; }
    #history-list { font-size: 14px; text-align: left; padding: 10px; background: #1a1a1a; border-radius: 8px; max-width: 600px; margin: auto; }
    .history-item { padding: 6px 0; border-bottom: 1px solid #444; }
    input, select { padding: 6px; margin: 4px; }
    #reward-form { background: #222; padding: 20px; margin-top: 20px; border-radius: 10px; max-width: 400px; margin-left: auto; margin-right: auto; }
    #bonus-status { text-align: center; margin-top: 10px; font-size: 13px; color: gray; }
  </style>
</head>
<body>

  <!-- Admin Bar -->
  <div class="admin-bar">
    <div id="auth-section">
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <button id="login-btn">Login</button>
    </div>
    <div id="admin-buttons" class="hidden">
      <button id="logout-btn">Logout</button>
      <button id="manage-btn" onclick="toggleRewardForm()">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
    </div>
  </div>

  <!-- Bonus Display Section -->
  <div class="bonus-section">
    <div style="text-align: center;"><img src="luxu-logo.png" style="width: 25%;"></div>
    <h2>üéâ Bonus High Hand</h2>
    <div class="bonus-row"><strong>Total Bonus:</strong> <span id="total-bonus">‡∏ø -</span></div>
    <div class="bonus-row"><strong>Royal Flush (75%):</strong> <span id="royal-flush">‡∏ø -</span></div>
    <div class="bonus-row"><strong>Straight Flush (45%):</strong> <span id="straight-flush">‡∏ø -</span></div>
    <div class="bonus-row"><strong>4 of a Kind (20%):</strong> <span id="four-kind">‡∏ø -</span></div>
    <div id="bonus-status">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏ö‡∏ô‡∏±‡∏™...</div>
    <div style="margin-top: 10px;">
      <button onclick="toggleHistory()">üîÅ Toggle History</button>
    </div>
    <div class="bonus-row" style="margin-top: 20px;">
      <strong>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•:</strong>
    </div>
    <div style="font-size: 14px; padding: 6px 10px; line-height: 1.6;">
      - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Total Bonus ‡∏ó‡∏µ‡πà 5,000 ‡∏ö‡∏≤‡∏ó<br>
      - ‡∏´‡∏≤‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 5,000 ‚Üí ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô 5,000<br>
      - ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 5,000 ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏° 500 ‡∏ó‡∏∏‡∏Å 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î<br>
      - Hight Hand 1 ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• / ‡∏ß‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    </div>
  </div>

  <!-- Reward Form (no image) -->
  <div id="reward-form" class="hidden">
    <h3>üì§ ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h3>
    <input type="text" id="reward-player" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô"><br>
    <input type="date" id="reward-date"><br>
    <select id="reward-type">
      <option value="Royal Flush">Royal Flush (75%)</option>
      <option value="Straight Flush">Straight Flush (45%)</option>
      <option value="4 of a Kind">4 of a Kind (20%)</option>
    </select><br>
    <button onclick="submitReward()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢</button>
    <button onclick="cancelRewardForm()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>

  </div>

  <!-- History Section -->
  <div id="history-container">
    <h3>üì∏ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h3>
    <div id="history-list"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, getDocs, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAtxMJQMwzhZz9QtiHuBlF4L58jRKgI90A",
      authDomain: "highthand-f9bc6.firebaseapp.com",
      projectId: "highthand-f9bc6",
      storageBucket: "highthand-f9bc6.appspot.com",
      messagingSenderId: "60442905889",
      appId: "1:60442905889:web:6d1f9f25a03e0a6a5dc260",
      measurementId: "G-G2CN0QMEJB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const authSection = document.getElementById("auth-section");
    const adminButtons = document.getElementById("admin-buttons");
    const rewardForm = document.getElementById("reward-form");
    const historyList = document.getElementById("history-list");
    const bonusStatus = document.getElementById("bonus-status");

    let bonusInterval = null;

    loginBtn.onclick = async () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        alert("Login failed: " + error.message);
      }
    };

    logoutBtn.onclick = async () => {
      await signOut(auth);
    };

    onAuthStateChanged(auth, user => {
      const isLoggedIn = !!user;
      authSection.classList.toggle("hidden", isLoggedIn);
      adminButtons.classList.toggle("hidden", !isLoggedIn);
      if (isLoggedIn) calculateBonus();
    });

    window.toggleHistory = function () {
      const box = document.getElementById("history-container");
      box.style.display = box.style.display === "none" ? "block" : "none";
    };

    onSnapshot(query(collection(db, "highhand_rewards"), orderBy("timestamp", "desc")), (snapshot) => {
      loadHistory(snapshot);
    });

    function updateBonusStatus(lastTime, total) {
      if (bonusInterval) clearInterval(bonusInterval);
      bonusInterval = setInterval(() => {
        const msPassed = new Date() - lastTime;
        const nextMs = 24 * 60 * 60 * 1000 - (msPassed % (24 * 60 * 60 * 1000));
        const nextH = Math.floor(nextMs / (1000 * 60 * 60));
        const nextM = Math.floor((nextMs % (1000 * 60 * 60)) / (1000 * 60));
        const nextS = Math.floor((nextMs % (1000 * 60)) / 1000);
        bonusStatus.innerText = `üìà ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß / ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô ${nextH} ‡∏ä‡∏°. ${nextM} ‡∏ô‡∏≤‡∏ó‡∏µ ${nextS} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
      }, 1000);
    }

    function loadHistory(snap) {
      historyList.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
      let html = "";
      let total = 5000;
      let lastTime = null;
      let rewards = [];

      snap.forEach(doc => {
        const data = doc.data();
        const time = data.timestamp?.toDate?.();
        if (!lastTime && time) lastTime = time;
        rewards.push({ ...data, time });
      });

      if (lastTime) {
        const hoursPassed = (new Date() - lastTime) / (1000 * 60 * 60);
        const bonusAdd = Math.floor(hoursPassed / 24) * 500;
        if (total > 5000) total += bonusAdd;
        else total = 5000;
      }

      rewards.reverse().forEach(d => {
        let percent = 0;
        if (d.type === "Royal Flush") percent = 0.75;
        if (d.type === "Straight Flush") percent = 0.45;
        if (d.type === "4 of a Kind") percent = 0.2;
        const payout = total * percent;
        total -= payout;

        const img = d.imgUrl ? `<img src='${d.imgUrl}' class='history-img' />` : "";
        const show = `<div class='history-item'>${img} üìå ${d.date || "-"} - ${d.player || "-"} (${d.type}) ‚Üí ‡∏ø ${payout.toFixed(0)}</div>`;
        html = show + html;
      });

      historyList.innerHTML = html || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    }

    window.toggleRewardForm = function () {
      rewardForm.classList.toggle("hidden");
    }

    async function calculateBonus() {
      const rewardSnap = await getDocs(query(collection(db, "highhand_rewards"), orderBy("timestamp", "desc")));
      let total = 5000;
      let lastTime = null;

      rewardSnap.forEach(doc => {
        const data = doc.data();
        const time = data.timestamp?.toDate?.();
        if (!lastTime && time) lastTime = time;

        if (data.type === "Royal Flush") total -= total * 0.75;
        if (data.type === "Straight Flush") total -= total * 0.45;
        if (data.type === "4 of a Kind") total -= total * 0.2;
      });

      let bonusAdd = 0;
      if (lastTime) {
        const msPassed = new Date() - lastTime;
        const hoursPassed = msPassed / (1000 * 60 * 60);
        bonusAdd = Math.floor(hoursPassed / 24) * 500;
        if (total > 5000) total += bonusAdd;
        else total = 5000;
        updateBonusStatus(lastTime, total);
      } else {
        bonusStatus.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏ö‡∏ô‡∏±‡∏™...";
      }

      document.getElementById("total-bonus").innerText = `‡∏ø ${total.toFixed(0)}`;
      document.getElementById("royal-flush").innerText = `‡∏ø ${(total * 0.75).toFixed(0)}`;
      document.getElementById("straight-flush").innerText = `‡∏ø ${(total * 0.45).toFixed(0)}`;
      document.getElementById("four-kind").innerText = `‡∏ø ${(total * 0.2).toFixed(0)}`;
    }

    window.submitReward = async function () {
      try {
        const user = auth.currentUser;
        if (!user) {
          alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö");
          return;
        }

        const snap = await getDocs(query(collection(db, "highhand_rewards"), orderBy("timestamp", "desc")));
        const last = snap.docs[0]?.data()?.timestamp?.toDate?.();
        if (last && (new Date() - last) < 24 * 60 * 60 * 1000) {
          alert("‚ùå ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á");
          return;
        }

        const player = document.getElementById("reward-player").value;
        const date = document.getElementById("reward-date").value;
        const type = document.getElementById("reward-type").value;

        await addDoc(collection(db, "highhand_rewards"), {
          player,
          date,
          type,
          imageUrl: "",
          timestamp: serverTimestamp()
        });

        alert("‚úÖ ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß");
        rewardForm.classList.add("hidden");
        calculateBonus();
      } catch (error) {
        console.error("üî• Firestore error:", error);
        alert("Upload failed: " + error.message);
      }
    }
    window.cancelRewardForm = function () {
  document.getElementById("reward-form").classList.add("hidden");
};

  </script>

</body>
</html>
